exports.handler = async (event, context) => {
  // Headers CORS
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Content-Type': 'application/json'
  };

  // Permitir OPTIONS
  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }

  // Só aceitar POST
  if (event.httpMethod !== 'POST') {
    return {
      statusCode: 405,
      headers,
      body: JSON.stringify({ success: false, error: 'Método não permitido' })
    };
  }

  try {
    // Novas credenciais da API PIX
    const publicKey = '55f2ede1-41a3-4b7c-b50b-1bf45ddf353d';
    const secretKey = '963985ef-8feb-43dd-8227-32b991ffde0f';

    // Ler dados
    const data = JSON.parse(event.body);
    const amount = parseFloat(data.amount || 0);
    const payer = data.payer || {};
    const description = data.description || `Doação para Moçambique - R$ ${amount.toFixed(2)}`;
    const externalReference = data.external_reference || null;

    if (amount <= 0) {
      return {
        statusCode: 400,
        headers,
        body: JSON.stringify({ success: false, error: 'Valor inválido' })
      };
    }

    // Validar dados do pagador
    const payerName = payer.name || 'Doador Anônimo';
    const payerEmail = payer.email || 'anonimo@doacao.com';

    console.log(`Gerando PIX para R$ ${amount} - Cliente: ${payerName} (${payerEmail})`);

    // Converter valor para centavos (a nova API trabalha em centavos)
    const amountInCents = Math.round(amount * 100);

    // Gerar identificador único para a transação
    const identifier = externalReference || 'doacao_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // Payload correto para nova API PIX
    const payload = {
      name: payerName,
      email: payerEmail,
      cpf: '12345678901', // CPF genérico válido (11 dígitos sem formatação)
      phone: '16999999999', // Telefone padrão (formato necessário: 8-12 dígitos)
      paymentMethod: 'PIX',
      amount: amountInCents,
      traceable: true,
      externalId: identifier,
      postbackUrl: 'https://silver-dango-fef4bf.netlify.app/.netlify/functions/webhook',
      items: [
        {
          unitPrice: amountInCents,
          title: description,
          quantity: 1,
          tangible: false
        }
      ]
    };

    console.log('Payload:', JSON.stringify(payload, null, 2));

    // Endpoint da nova API PIX
    const endpoint = 'https://app.ghostspaysv1.com/api/v1/transaction.purchase';

    try {
      console.log(`Chamando: ${endpoint}`);
      
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': secretKey
        },
        body: JSON.stringify(payload)
      });

      console.log(`Status: ${response.status}`);
      
      if (response.ok) {
        const result = await response.json();
        console.log('✅ SUCESSO!', JSON.stringify(result, null, 2));
        
        return {
          statusCode: 200,
          headers,
          body: JSON.stringify({
            success: true,
            payment_id: result.id,
            transaction_id: result.transactionId,
            amount: amount,
            pix_qr_code: result.pixQrCode,
            pix_code: result.pixCode,
            status: result.status,
            expires_at: result.expiresAt,
            message: 'PIX gerado com sucesso!'
          })
        };
      } else {
        const errorText = await response.text();
        console.log(`❌ Falhou: ${response.status} - ${errorText}`);
        
        let errorMessage = 'Erro ao gerar PIX';
        try {
          const errorJson = JSON.parse(errorText);
          errorMessage = errorJson.message || errorMessage;
        } catch (e) {
          // Se não conseguir parsear JSON, usa o texto direto
        }
        
        return {
          statusCode: response.status,
          headers,
          body: JSON.stringify({
            success: false,
            error: errorMessage,
            details: errorText
          })
        };
      }
    } catch (error) {
      console.log(`❌ Erro de conexão: ${error.message}`);
      return {
        statusCode: 500,
        headers,
        body: JSON.stringify({
          success: false,
          error: `Erro de conexão: ${error.message}`
        })
      };
    }

  } catch (error) {
    console.error('Erro geral:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({
        success: false,
        error: `Erro interno: ${error.message}`
      })
    };
  }
};
